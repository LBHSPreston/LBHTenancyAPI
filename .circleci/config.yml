version: 2
jobs:
  check:
    machine: true
    # docker:
    #   - image: microsoft/dotnet:2.1-sdk
    steps:
      - checkout
      - run:
          name: Build
          command: dotnet build LBHTenancyAPI.sln
      - run:
          name: Install Docker client
          command: |
            set -x
            VER="17.03.0-ce"
            curl -L -o /tmp/docker-$VER.tgz https://get.docker.com/builds/Linux/x86_64/docker-$VER.tgz
            tar -xz -C /tmp -f /tmp/docker-$VER.tgz
            mv /tmp/docker/* /usr/bin

      - setup_remote_docker

      - run:
          name: Install Docker Compose
          command: |
            curl -L https://github.com/docker/compose/releases/download/1.19.0/docker-compose-`uname -s`-`uname -m` > ~/docker-compose
            chmod +x ~/docker-compose
            mv ~/docker-compose /usr/local/bin/docker-compose
      - run:
          name: Build StubUniversalHousing
          command: docker-compose build
      # - run:
      #     name: Spin up Stub Universal Housing
      #     command: docker-compose run -d --service-ports --rm stubuniversalhousing
      - run:
          name: Spin up Stub Universal Housing
          command: docker-compose up -d
      - run:
          name: Test
          command: sleep 20 ; dotnet test LBHTenancyAPITest
      - run:
          name: Lint
          command: echo ...............

  staging_release:
    machine: true
    working_directory: ~/repo/LBHTenancyAPI
    steps:
      - checkout:
          path: ~/repo
      - run:
          name: Install Heroku CLI
          command: bash ../.circleci/install-heroku.sh
      - run:
          name: Login to Heroku Container Registry
          command: heroku container:login
      - run:
          name: Build new application Docker image
          command: heroku container:push web --context-path=.. --app=lbh-tenancy-api-staging
      - run:
          name: Release new version to staging
          command: heroku container:release web --app=lbh-tenancy-api-staging

  production_release:
    machine: true
    working_directory: ~/repo/LBHTenancyAPI
    steps:
      - checkout:
          path: ~/repo
      - run:
          name: Install Heroku CLI
          command: bash ../.circleci/install-heroku.sh
      - run:
          name: Login to Heroku Container Registry
          command: heroku container:login
      - run:
          name: Build new application Docker image
          command: heroku container:push web --context-path=.. --app=lbh-tenancy-api-production
      - run:
          name: Release new version to production
          command: heroku container:release web --app=lbh-tenancy-api-production

workflows:
  version: 2
  continuous_delivery:
    jobs:
      - check
      - staging_release:
          requires:
            - check
          filters:
            branches:
              only: master
      - permit_production_release:
          type: approval
          requires:
            - staging_release
      - production_release:
          requires:
            - permit_production_release
